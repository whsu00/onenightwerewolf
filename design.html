
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>One Night Ultimate Werewolf</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
      html, body, .container {
        height: 100%;
      }
      .no-u {
        text-decoration: none!important;
      }
    </style>
  </head>
  <body class="text-center">
    <div class="container align-items-center">
      <div class="row">
        <div class="col"></div>
        <div class="col-md-8 col-lg-5">
          <br>
          <h1 class="h3 mb-3 font-weight-normal">One Night Ultimate Werewolf</h1>
          <div id="Init" class="card">
            <div class="card-header font-weight-bold">Create or Join a game</div>
            <div class="card-body text-left">
              <div class="form-group">
                <label for="name">Name</label>
                <input type="text" class="form-control" id="name" placeholder="Name">
              </div>
              <div class="form-group">
                <label for="group">Group Code</label>
                <input type="number" class="form-control" id="group" aria-describedby="groupHelp" placeholder="Group Code">
                <small id="groupHelp" class="form-text text-muted">Leave blank to create a new group.</small>
              </div>
            </div>
            <div class="card-footer">
              <a href="#" class="card-link Play">Play</a>
            </div>
          </div>
          <div id="Waiting" class="card">
            <div class="card-header font-weight-bold">Waiting for players</div>
            <div class="card-body">
              <p class="card-text m-0">Group Code</p>
              <p class="card-text h3 Code">1234</p>
            </div>
            <ul class="list-group list-group-flush text-left PlayerList">
              <li class="list-group-item d-flex justify-content-between align-items-center"><span>William</span><a href="#" class="text-muted no-u x">&times;</a></li>
              <li class="list-group-item d-flex justify-content-between align-items-center"><span>Grace</span><a href="#" class="text-muted no-u x">&times;</a></li>
              <li class="list-group-item d-flex justify-content-between align-items-center"><span>Edmund</span><a href="#" class="text-muted no-u x">&times;</a></li>
            </ul>
            <div class="card-footer">
              <a href="#" class="card-link Next">Next</a>
              <a href="#" class="card-link text-danger Quit">Quit</a>
            </div>
          </div>
          <div id="Selecting" class="card">
            <div class="card-header font-weight-bold">Select roles to use</div>
            <div class="card-body">
              <p class="card-text">Please select <mark class="Number">6</mark> roles.</p>
              <div class="row">
                <div class="col d-flex flex-column">
                  <a href="#" name="r1" class="badge badge-secondary m-1 p-1 Role">Werewolf</a>
                  <a href="#" name="r2" class="badge badge-secondary m-1 p-1 Role">Werewolf</a>
                  <a href="#" name="r3" class="badge badge-secondary m-1 p-1 Role">Minion</a>
                  <a href="#" name="r4" class="badge badge-secondary m-1 p-1 Role">Seer</a>
                  <a href="#" name="r5" class="badge badge-secondary m-1 p-1 Role">Robber</a>
                  <a href="#" name="r6" class="badge badge-secondary m-1 p-1 Role">Troublemaker</a>
                  <a href="#" name="r7" class="badge badge-secondary m-1 p-1 Role">Drunk</a>
                  <a href="#" name="r8" class="badge badge-secondary m-1 p-1 Role">Insomniac</a>
                </div>
                <div class="col d-flex flex-column">
                  <a href="#" name="r9" class="badge badge-secondary m-1 p-1 Role">Villager</a>
                  <a  href="#" name="r10" class="badge badge-secondary m-1 p-1 Role">Villager</a>
                  <a  href="#" name="r11" class="badge badge-secondary m-1 p-1 Role">Villager</a>
                  <a  href="#" name="r12" class="badge badge-secondary m-1 p-1 Role">Mason</a>
                  <a  href="#" name="r13" class="badge badge-secondary m-1 p-1 Role">Mason</a>
                  <a  href="#" name="r14" class="badge badge-secondary m-1 p-1 Role">Hunter</a>
                  <a  href="#" name="r15" class="badge badge-secondary m-1 p-1 Role">Tanner</a>
                  <a  href="#" name="r16" class="badge badge-secondary m-1 p-1 Role">Doppelganger</a>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <a href="#" class="card-link Start">Start</a>
              <a href="#" class="card-link text-danger Exit">Back</a>
            </div>
          </div>
          <div id="Night" class="card">
            <div class="card-header font-weight-bold">Night View</div>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <p class="h6 m-0">Center</p>
                <p class="m-0 CenterCards">
                  <a href="#" class="badge badge-secondary m-1 p-1 Center">Card 1</a>
                  <a href="#" class="badge badge-secondary m-1 p-1 Center">Card 2</a>
                  <a href="#" class="badge badge-secondary m-1 p-1 Center">Card 3</a>
                </p>
              </li>
              <li class="list-group-item">
                <p class="h6 m-0">Players</p>
                <p class="m-0 PlayerCards">
                  <a href="#" class="badge badge-secondary m-1 p-1 Player">William</a>
                  <a href="#" class="badge badge-secondary m-1 p-1 Player">Grace</a>
                  <a href="#" class="badge badge-secondary m-1 p-1 Player">Edmund</a>
                </p>
              </li>
            </ul>
            <div class="card-body">
              <p class="card-text">You are a <mark class="You">Doppelganger</mark>.</p>
              <p class="card-text">It is not your turn.</p>
            </div>
            <div class="card-footer">
              <a href="#" class="card-link text-muted">Done</a>
              <a href="#" class="card-link text-danger Exit">Exit</a>
            </div>
          </div>
          <div id="Turn" class="card">
            <div class="card-header font-weight-bold">Your turn</div>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <p class="h6 m-0">Center</p>
                <p class="m-0 CenterCards">
                  <a href="#" class="badge badge-secondary m-1 p-1 Center">Card 1</a>
                  <a href="#" class="badge badge-secondary m-1 p-1 Center">Card 2</a>
                  <a href="#" class="badge badge-secondary m-1 p-1 Center">Card 3</a>
                </p>
              </li>
              <li class="list-group-item">
                <p class="h6 m-0">Players</p>
                <p class="m-0 PlayerCards">
                  <a href="#" class="badge badge-secondary m-1 p-1 Player">William</a>
                  <a href="#" class="badge badge-secondary m-1 p-1 Player">Grace</a>
                  <a href="#" class="badge badge-secondary m-1 p-1 Player">Edmund</a>
                </p>
              </li>
            </ul>
            <div class="card-body">
              <p class="card-text">You are a <mark class="You">Doppelganger</mark>.</p>
              <p class="Description">Doppelganger, wake up. Choose another player's card.</p>
            </div>
            <div class="card-footer">
              <a href="#" class="card-link EndTurn">Done</a>
              <a href="#" class="card-link text-danger Exit">Exit</a>
            </div>
          </div>
          <div id="Day" class="card">
            <div class="card-header font-weight-bold">Day View</div>
            <div class="card-body">
              <p class="card-text m-0">Time Left</p>
              <p class="card-text h3 Time">4:59</p>
              <div class="row">
                <div class="col">
                  <p class="h6 m-0">Roles</p>
                  <p class="m-0 d-flex flex-column DisplayRoles">
                    <a href="#" class="badge badge-secondary m-1 p-1 DisplayRole">Werewolf</a>
                    <a href="#" class="badge badge-secondary m-1 p-1 DisplayRole">Seer</a>
                    <a href="#" class="badge badge-secondary m-1 p-1 DisplayRole">Robber</a>
                    <a href="#" class="badge badge-secondary m-1 p-1 DisplayRole">Troublemaker</a>
                    <a href="#" class="badge badge-secondary m-1 p-1 DisplayRole">Drunk</a>
                    <a href="#" class="badge badge-secondary m-1 p-1 DisplayRole">Insomniac</a>
                  </p>
                </div>
                <div class="col">
                  <p class="h6 m-0">Players</p>
                  <p class="m-0 d-flex flex-column DisplayPlayers">
                    <a href="#" class="badge badge-secondary m-1 p-1 DisplayPlayer">William</a>
                    <a href="#" class="badge badge-secondary m-1 p-1 DisplayPlayer">Grace</a>
                    <a href="#" class="badge badge-secondary m-1 p-1 DisplayPlayer">Edmund</a>
                  </p>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <a href="#" class="card-link VoteNow">Vote Now</a>
              <a href="#" class="card-link text-danger Exit">Exit</a>
            </div>
          </div>
          <div id="Voting" class="card">
            <div class="card-header font-weight-bold">Voting</div>
            <div class="card-body">
              <p class="card-text m-0">Time Left</p>
              <p class="card-text h3 Time">0:10</p>
              <div class="row">
                <div class="col">
                  <p class="h6 m-0">Players</p>
                  <p class="m-0 VotingCards">
                    <a href="#" class="badge badge-secondary m-1 p-1 Player">William</a>
                    <a href="#" class="badge badge-secondary m-1 p-1 Player">Grace</a>
                    <a href="#" class="badge badge-secondary m-1 p-1 Player">Edmund</a>
                  </p>
                </div>
              </div>
            </div>
            <div class="card-footer">
              <a href="#" class="card-link text-muted">Vote Now</a>
              <a href="#" class="card-link text-danger Exit">Exit</a>
            </div>
          </div>
          <div id="Results" class="card">
            <div class="card-header font-weight-bold">Results</div>
            <div class="card-body">
              <p class="display-4 Outcome">Villagers win!</p>
              <p class="card-text">Executed: <span class="Execution">Edmund (Werewolf)</span></p>
            </div>
            <ul class="list-group list-group-flush text-left Results">
              <li class="list-group-item d-flex"><span>William</span><span>: Werewolf &rarr; Robber</span></li>
              <li class="list-group-item d-flex"><span>Grace</span><span>: Drunk &rarr; Seer</span></li>
              <li class="list-group-item d-flex"><span>Edmund</span><span>: Robber &rarr; Werewolf</span></li>
            </ul>
            <div class="card-footer">
              <a href="#" class="card-link PlayAgain">Play Again</a>
              <a href="#" class="card-link text-danger Quit">Quit</a>
            </div>
          </div>
        </div>
        <div class="col"></div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
<script>
//$(function () {
var socket = io();
socket.on("disconnect", () => {
  alert("connection lost. refreshing.");
  location.reload();
});

$("#Init").show();
$("#Waiting").hide();
$("#Selecting").hide();
$("#Night").hide();
$("#Turn").hide();
$("#Day").hide();
$("#Voting").hide();
$("#Results").hide();

var lock = {
  value: -1,
  verify: (val) => {
    return val == value;
  },
  set: (val) => {
    value = val;
    return true;
  }
};
/* Lock values:
10 - On INIT
11 - Waiting for INIT RESPONSE/OK
12 - On WAITING
13 - Waiting for WAITING RESPONSE/OK
14 - On SELECTING
15 - Waiting for SELECTING RESPONSE/OK
16 - On NIGHT
17 - N/A
18 - On TURN
19 - Waiting for TURN RESPONSE/OK
20 - On DAY
21 - Waiting for DAY (VOTECLICK) RESPONSE/OK
22 - On VOTING
23 - N/A
24 - On RESULTS
*/

var myId = -1;
var myGame = -1;

var selection = [];
var selectionType = "N/A"; //"N/A", "Player", "Center", "Seer"
var selectionNum = 0; //0, 1, 2, -1

// ========== INIT ==========
lock.set(10);
$(".Play").click((e) => {
  if (lock.verify(10)) {
    lock.set(11);
    //EVENT FIRE "init:request"
    socket.emit("init:request", $("#name").val(), $("#group").val());
  }
});
socket.on("init:request-ok", (ok, id, code, players) => {
  if (ok) {
    lock.set(12);

    myId = id;
    myGame = code;
    
    //UI SETUP FOR WAITING
    $(".Code").html(code);
    $(".PlayerList").html("");
    players.forEach((player) => {
      $(".PlayerList").append("<li class=\"list-group-item d-flex justify-content-between align-items-center\"><span>" + player.name + "</span><a class=\"text-muted no-u x\"></a></li>");
    });
    $(".Number").html(players.length+3);

    $("#Init").slideUp();
    $("#Waiting").slideDown();
    $("#Selecting").slideUp();
    $("#Night").slideUp();
    $("#Turn").slideUp();
    $("#Day").slideUp();
    $("#Voting").slideUp();
    $("#Results").slideUp();
  }
  else {
    lock.set(10);
    //TODO: FAIL
    alert("error: either group code not found, game in progress, or name taken");
  }
});

// ========== WAITING ==========
$(".Next").click((e) => {
  if (lock.verify(12)) {
    lock.set(13);
    //EVENT FIRE "waiting:next"
    socket.emit("waiting:next", myId, myGame);
  }
});
$(".Quit").click((e) => {
  //EVENT FIRE "waiting:quit"
  socket.emit("waiting:quit", myId, myGame);
  $("#Waiting").slideUp();
  $("#Init").slideDown();
});
socket.on("waiting:update", (ok, players) => {
  if (ok) {
    //UI UPDATE FOR WAITING
    $(".PlayerList").html("");
    players.forEach((player) => {
      $(".PlayerList").append("<li class=\"list-group-item d-flex justify-content-between align-items-center\"><span>" + player.name + "</span><a href=\"#\" class=\"text-muted no-u x\"></a></li>");
    });
    $(".Number").html(players.length+3);
  }
});
socket.on("waiting:next-ok", (ok) => {
  if (ok) {
    lock.set(14);

    //UI SETUP FOR SELECTING
    $(".Role").addClass("badge-secondary").removeClass("badge-primary");

    $("#Waiting").slideUp();
    $("#Results").slideUp();
    $("#Selecting").slideDown();
  }
  else {
    lock.set(12);
    //SHOULD NOT FAIL
  }
});

// ========== SELECTING ==========
$(".Role").click((e) => {
  if (lock.verify(14)) {
    //EVENT FIRE "selecting:select"
    socket.emit("selecting:select", myId, myGame, $(e.target).attr("name"));
  }
});
$(".Start").click((e) => {
  if (lock.verify(14)) {
    lock.set(15);
    //EVENT FIRE "selecting:start"
    socket.emit("selecting:start", myId, myGame);
  }
});
$(".Exit").click((e) => {
  //EVENT FIRE "exit"
  socket.emit("exit", myId, myGame); //server should response with init:request-ok
});
socket.on("selecting:update", (ok, roles) => {
  if (ok) {
    //UI UPDATE FOR SELECTING
    $(".Role").addClass("badge-secondary").removeClass("badge-primary");
    roles.forEach((id) => {
      $("[name='" + id + "']").addClass("badge-primary").removeClass("badge-secondary");
    });
  }
});
socket.on("selecting:start-ok", (ok, you, center, players) => {
  if (ok) {
    lock.set(16);

    //UI SETUP FOR NIGHT/TURN
    selection = [];
    $(".You").html(you);
    $(".CenterCards").html("");
    for (var i = 0; i < center.length; i++) {
      $(".CenterCards").append("<a href=\"#\" name=\"" + i + "\" class=\"badge badge-secondary m-1 p-1 Center\">Card " + (i+1) + "</a>");
    }
    $(".CenterCards .Center").click((e) => {
      if ($(e.target).hasClass("badge-primary")) {
        selection.splice(selection.indexOf($(e.target).attr("name")), 1);
        $(e.target).addClass("badge-secondary").removeClass("badge-primary");
      }
      else if ((selectionType == "Center" && selection.length < selectionNum)
          || (selectionType == "Seer" && (selection.length == 0 
          || (selection.length == 1 && selection[0].length < 3)))) {
        selection.push($(e.target).attr("name"));
        $(e.target).addClass("badge-primary").removeClass("badge-secondary");
      }
    });
    $(".PlayerCards").html("");
    players.forEach((player) => {
      $(".PlayerCards").append("<a href=\"#\" name=\"" + player.id + "\" class=\"badge badge-secondary m-1 p-1 Player\">" + player.name + "</a>");
    });
    $(".PlayerCards .Player").click((e) => {
      if (selectionType == "Player" || selectionType == "Seer") {
        if ($(e.target).hasClass("badge-primary")) {
          selection.splice(selection.indexOf($(e.target).attr("name")), 1);
          $(e.target).addClass("badge-secondary").removeClass("badge-primary");
        }
        else {
          if ((selectionType == "Player" && selection.length < selectionNum)
            || (selectionType == "Seer" && selection.length == 0)) {
            selection.push($(e.target).attr("name"));
            $(e.target).addClass("badge-primary").removeClass("badge-secondary");
          }
        }
      }
    });

    $("#Selecting").slideUp();
    $("#Night").slideDown();
  }
  else {
    lock.set(14);
    //TODO: FAIL
    alert("error: probably not enough roles");
  }
});

// ========== NIGHT ==========
socket.on("night:to-turn", (ok, desc, type, num) => {
  if (ok) {
    lock.set(18);

    //UI SETUP FOR TURN
    $(".Description").html(desc);
    //modify vars for CenterCards, PlayerCards that are already set up
    selection = [];
    selectionType = type;
    selectionNum = num;
    $(".CenterCards .Center").addClass("badge-secondary").removeClass("badge-primary");
    $(".PlayerCards .Player").addClass("badge-secondary").removeClass("badge-primary");

    $("#Night").slideUp();
    $("#Turn").slideDown();
  }
  else {
    lock.set(16);
    //SHOULD NOT FAIL
  }
});
socket.on("night:to-day", (ok, roles, players) => {
  if (ok) {
    lock.set(20);

    //UI SETUP FOR DAY
    $(".DisplayRoles").html("");
    roles.forEach((role) => {
      $(".DisplayRoles").append("<a href=\"#\" class=\"badge badge-secondary m-1 p-1 DisplayRole\">" + role + "</a>");
    })
    $(".DisplayRoles .DisplayRole").click((e) => {
      if ($(e.target).hasClass("badge-secondary")) {
        $(e.target).addClass("badge-primary").removeClass("badge-secondary");
      }
      else {
        $(e.target).addClass("badge-secondary").removeClass("badge-primary");
      }
    });
    $(".DisplayPlayers").html("");
    players.forEach((player) => {
      $(".DisplayPlayers").append("<a href=\"#\" class=\"badge badge-secondary m-1 p-1 DisplayPlayer\">" + player.name + "</a>");
    });
    $(".DisplayPlayers .DisplayPlayer").click((e) => {
      if ($(e.target).hasClass("badge-secondary")) {
        $(e.target).addClass("badge-primary").removeClass("badge-secondary");
      }
      else {
        $(e.target).addClass("badge-secondary").removeClass("badge-primary");
      }
    });

    $("#Night").slideUp();
    $("#Day").slideDown();
  }
  else {
    lock.set(16);
    //SHOULD NOT FAIL
  }
});

// ========== TURN ==========
$(".EndTurn").click((e) => {
  if (lock.verify(18)) {
    lock.set(19);
    //TODO ERROR CHECKING
    if (selectionType == "Seer" && selection.length == 0) {
      alert("pls select something");
      lock.set(18);
      return false;
    }
    if (selectionType != "Seer" && selectionNum != selection.length) {
      alert("not enough selected");
      lock.set(18);
      return false;
    }
    if ((selection.length >= 1 && selection[0] == myId) || (selection.length >= 2 && selection[1] == myId)) {
      alert("no select self");
      lock.set(18);
      return false;
    }
    //EVENT FIRE "turn:action"
    socket.emit("turn:action", myId, myGame, selection);
    /*
    selection = [];
    selectionType = "N/A";
    selectionNum = 0;
    $(".CenterCards .Center").addClass("badge-secondary").removeClass("badge-secondary");
    $(".PlayerCards .Player").addClass("badge-secondary").removeClass("badge-secondary");
    */
  }
});
socket.on("turn:action-ok", (ok, you) => {
  if (ok) {
    lock.set(16);

    //UI RESETUP FOR NIGHT
    $(".You").html(you);

    $("#Turn").slideUp();
    $("#Night").slideDown();
  }
  else {
    lock.set(18);
    alert("error: you're doing something wrong");
  }
});

// ========== DAY ==========
$(".VoteNow").click((e) => {
  if (lock.verify(20)) {
    lock.set(21);
    //EVENT FIRE "day:votenow"
    socket.emit("day:votenow", myId, myGame);
  }
});
socket.on("time", (ok, time) => {
  if (ok) {
    //UI UPDATE FOR DAY & VOTING
    $(".Time").html(time);
  }
});
socket.on("day:votenow-ok", (ok, players) => {
  if (ok) {
    lock.set(22);
    
    //UI SETUP FOR VOTING
    $(".VotingCards").html("");
    players.forEach((player) => {
      $(".VotingCards").append("<a href=\"#\" name=\"" + player.id + "\" class=\"badge badge-secondary m-1 p-1 Player\">" + player.name + "</a>");
    });
    $(".VotingCards .Player").click((e) => {
      socket.emit("voting:vote", myId, myGame, $(e.target).attr("name"));
      $(e.target).addClass("badge-primary").removeClass("badge-secondary").siblings().addClass("badge-secondary").removeClass("badge-primary");
    });
    
    $("#Day").slideUp();
    $("#Voting").slideDown();
  }
  else {
    lock.set(20);
    //SHOULD NOT FAIL
  }
});

// ========== VOTING ==========
socket.on("voting:to-results", (ok, outcome, execution, players) => {
  if (ok) {
    lock.set(24);
    
    //UI SETUP FOR RESULTS
    $(".Outcome").html(outcome);
    $(".Execution").html(execution);
    $(".Results").html("");
    players.forEach((player) => {
      var history = "";
      player.history.forEach((role) => {
        history += " &rarr; " + role;
      });
      history = history.substring(8);
      $(".Results").append("<li class=\"list-group-item d-flex\"><span>" + player.name + "</span><span>: " + history + "</span></li>");
    });

    $("#Voting").slideUp();
    $("#Results").slideDown();
  }
  else {
    lock.set(22);
    //SHOULD NOT FAIL
  }
});

// ========== RESULTS ==========
$(".PlayAgain").click((e) => {
  if (lock.verify(24)) {
    lock.set(12);
    //NO UI SETUP FOR WAITING NEEDED
    $("#Results").slideUp();
    $("#Waiting").slideDown();
  }
});

//});
</script>
  </body>
</html>
